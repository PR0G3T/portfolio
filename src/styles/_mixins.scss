@use 'variables' as v;
@use 'sass:map';
@use 'sass:color';

// Responsive mixins - Improved consistency
@mixin mobile {
  @media (max-width: v.$breakpoint-mobile-max) {
    @content;
  }
}

@mixin tablet {
  @media (min-width: v.$breakpoint-tablet-min) and (max-width: v.$breakpoint-tablet-max) {
    @content;
  }
}

@mixin desktop {
  @media (min-width: v.$breakpoint-desktop-min) {
    @content;
  }
}

// Flexbox mixins
@mixin flex-center {
  display: flex;
  align-items: center;
  justify-content: center;
}

@mixin flex-between {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

@mixin flex-start {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
}

@mixin flex-column {
  display: flex;
  flex-direction: column;
}

// DRY Card Component Mixin - Eliminates repetition across all card types
@mixin card-component($type: 'base', $options: ()) {
  $defaults: (
    'header-layout': 'flex-start',
    'logo-size': v.$logo-size,
    'logo-mobile-size': v.$logo-size-mobile,
    'icon-size': v.$icon-size,
    'icon-mobile-size': v.$icon-size-mobile,
    'gap': v.$spacing-lg,
    'mobile-gap': v.$spacing-md,
    'use-icon': false,
    'use-logo': true,
    'meta-layout': 'space-between',
  );

  $config: map.merge($defaults, $options);

  // Base card styles
  @include card-base;

  // Info section - déclaré en premier pour éviter les mixed-decls
  .#{$type}-card-info {
    flex: 1;
    min-width: 0;
  }

  // Content section - déclaré en premier pour éviter les mixed-decls
  .#{$type}-card-content {
    flex: 1;
  }

  // Header with flexible layout
  .#{$type}-card-header {
    @include card-header;
    @include flex-layout(map.get($config, 'header-layout'));
    gap: map.get($config, 'gap');

    @include mobile {
      flex-direction: column;
      gap: map.get($config, 'mobile-gap');
    }
  }

  // Logo if enabled
  @if map.get($config, 'use-logo') {
    .#{$type}-card-logo {
      @include logo-base(map.get($config, 'logo-size'));
      @include logo-mobile(map.get($config, 'logo-mobile-size'));
    }

    .#{$type}-logo-image {
      @include logo-image;
    }
  }

  // Icon if enabled
  @if map.get($config, 'use-icon') {
    .#{$type}-card-icon {
      @include icon-base(map.get($config, 'icon-size'));

      @include mobile {
        width: map.get($config, 'icon-mobile-size');
        height: map.get($config, 'icon-mobile-size');
      }
    }
  }

  // Meta section with flexible layout
  .#{$type}-card-meta {
    justify-content: map.get($config, 'meta-layout');
    @include card-meta;
  }
}

// DRY Text Component Mixin - Eliminates text style repetition
@mixin text-component($type: 'primary', $options: ()) {
  $defaults: (
    'size': v.$font-size-2xl,
    'color': v.$primary-color,
    'weight': 600,
    'margin': 0,
    'line-height': 1.3,
    'mobile-size': v.$font-size-xl,
    'mobile-weight': 600,
  );

  $config: map.merge($defaults, $options);

  // Toutes les déclarations avant les règles imbriquées
  font-size: map.get($config, 'size');
  color: map.get($config, 'color');
  font-weight: map.get($config, 'weight');
  margin: map.get($config, 'margin');
  line-height: map.get($config, 'line-height');

  @include mobile {
    font-size: map.get($config, 'mobile-size');
    font-weight: map.get($config, 'mobile-weight');
  }
}

// DRY Layout Component Mixin - Eliminates layout repetition
@mixin layout-component($type: 'grid', $options: ()) {
  $defaults: (
    'columns': 1fr 1fr,
    'mobile-columns': 1fr,
    'gap': v.$spacing-xl,
    'mobile-gap': v.$spacing-lg,
    'direction': 'row',
    'wrap': 'wrap',
    'align': 'flex-start',
    'justify': 'space-between',
  );

  $config: map.merge($defaults, $options);

  @if $type == 'grid' {
    @include grid-responsive(map.get($config, 'columns'), map.get($config, 'mobile-columns'));
  } @else if $type == 'flex' {
    display: flex;
    flex-direction: map.get($config, 'direction');
    flex-wrap: map.get($config, 'wrap');
    align-items: map.get($config, 'align');
    justify-content: map.get($config, 'justify');
    gap: map.get($config, 'gap');

    @include mobile {
      gap: map.get($config, 'mobile-gap');
    }
  }
}

// Helper mixins for the DRY components
@mixin flex-layout($type) {
  @if $type == 'flex-start' {
    @include flex-start;
  } @else if $type == 'flex-between' {
    @include flex-between;
  } @else if $type == 'flex-center' {
    @include flex-center;
  } @else if $type == 'flex-column' {
    @include flex-column;
  }
}

@mixin logo-image {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: v.$border-radius-sm;
}

// Card mixins
@mixin card-base {
  background: v.$background-white;
  border: 1px solid v.$border-light;
  border-radius: v.$border-radius-lg;
  padding: v.$spacing-lg;
  box-shadow: v.$shadow-sm;
  height: fit-content;
  box-sizing: border-box;
  max-width: 100%; // Empêche le débordement
  // Retiré overflow-x: auto pour permettre l'agencement vertical naturel

  @include mobile {
    padding: v.$spacing-md;
  }
}

@mixin card-header {
  margin-bottom: v.$spacing-md;
  padding-bottom: v.$spacing-md;
  border-bottom: 1px solid v.$border-light;
}

@mixin card-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: v.$spacing-sm;
  flex-wrap: wrap;
  gap: v.$spacing-sm;

  @include mobile {
    flex-direction: column;
    align-items: flex-start;
    gap: v.$spacing-sm;
  }
}

// Logo mixins
@mixin logo-base($size: v.$logo-size) {
  flex-shrink: 0;
  width: $size;
  height: $size;
  @include flex-center;
  background: v.$background-white;
  border-radius: v.$border-radius-md;
  box-shadow: v.$shadow-sm;
  padding: v.$spacing-sm;
  border: 1px solid v.$border-light;
}

@mixin logo-mobile($mobile-size: v.$logo-size-mobile) {
  @include mobile {
    width: $mobile-size;
    height: $mobile-size;
    align-self: flex-start;
  }
}

// Icon mixins
@mixin icon-base($size: v.$icon-size) {
  flex-shrink: 0;
  width: $size;
  height: $size;
  @include flex-center;
  background: v.$primary-color;
  border-radius: v.$border-radius-md;
  color: white;
  font-size: v.$font-size-lg;
  font-weight: 600;

  @include mobile {
    width: v.$icon-size-mobile;
    height: v.$icon-size-mobile;
    font-size: v.$font-size-base;
  }
}

// Typography mixins - Now using the DRY text component
@mixin heading-primary {
  border-bottom: 2px solid v.$border-light;
  padding-bottom: v.$spacing-sm;
  @include text-component(
    'heading',
    (
      'size': v.$font-size-3xl,
      'color': v.$primary-color,
      'weight': 600,
      'margin': 0 0 v.$spacing-lg 0,
    )
  );
}

@mixin text-primary {
  @include text-component(
    'primary',
    (
      'size': v.$font-size-2xl,
      'color': v.$primary-color,
      'weight': 600,
      'margin': 0,
      'line-height': 1.3,
    )
  );
  flex: 1;
  min-width: 0; // Permet au texte de se rétrécir
  word-wrap: break-word;
  hyphens: auto;
  overflow-wrap: break-word; // Empêche le débordement
  word-break: break-word; // Ajouté pour une meilleure gestion du texte long
  max-width: 100%; // Empêche le débordement
}

@mixin text-secondary {
  @include text-component(
    'secondary',
    (
      'size': v.$font-size-lg,
      'color': v.$text-light,
      'weight': 500,
      'margin': 0,
    )
  );
}

@mixin text-muted {
  @include text-component(
    'muted',
    (
      'size': v.$font-size-xs,
      'color': v.$text-muted,
      'weight': 500,
      'margin': 0,
    )
  );
  white-space: nowrap;
}

// Grid mixins
@mixin grid-responsive($columns: 1fr 1fr, $mobile-columns: 1fr) {
  display: grid;
  grid-template-columns: $columns;
  gap: v.$spacing-xl;
  width: 100%;

  @include mobile {
    grid-template-columns: $mobile-columns;
    gap: v.$spacing-lg;
  }
}

@mixin grid-auto-fit($min-width: 350px, $mobile-min: 1fr) {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax($min-width, 1fr));
  gap: v.$spacing-xl;
  width: 100%;

  @include mobile {
    grid-template-columns: $mobile-min;
    gap: v.$spacing-lg;
  }

  @include tablet {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  @include desktop {
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  }
}

// Transition mixins
@mixin transition-base {
  transition: all v.$transition-smooth;
}

// List mixins
@mixin list-styled {
  margin: 0;
  padding-left: v.$spacing-lg;
  color: v.$text-secondary;
  font-size: v.$font-size-sm;
  line-height: 1.6;

  @include mobile {
    padding-left: v.$spacing-md;
  }

  li {
    margin-bottom: v.$spacing-sm;
    position: relative;

    &::before {
      content: '•';
      color: v.$text-muted;
      font-weight: bold;
      position: absolute;
      left: calc(-1 * v.$spacing-md);
      top: 0;
    }

    &:last-child {
      margin-bottom: 0;
    }
  }
}

// DRY Button Component Mixin
@mixin button-component($type: 'primary', $options: ()) {
  $defaults: (
    'background': v.$code-bg,
    'color': v.$text-secondary,
    'border': v.$code-border,
    'padding': v.$spacing-sm v.$spacing-md,
    'font-size': v.$font-size-sm,
    'font-weight': 500,
    'border-radius': v.$border-radius-lg,
    'hover-bg': color.scale(v.$code-bg, $lightness: -5%),
    'hover-color': v.$text-secondary,
  );

  $config: map.merge($defaults, $options);

  @include flex-center;
  gap: v.$spacing-sm;
  padding: map.get($config, 'padding');
  background: map.get($config, 'background');
  border: 1px solid map.get($config, 'border');
  border-radius: map.get($config, 'border-radius');
  text-decoration: none;
  color: map.get($config, 'color');
  font-size: map.get($config, 'font-size');
  font-weight: map.get($config, 'font-weight');
  width: fit-content;
  min-width: fit-content;
  position: relative;
  overflow: visible;
  white-space: nowrap;
  @include transition-base;

  &:hover {
    background: map.get($config, 'hover-bg');
    color: map.get($config, 'hover-color');
  }
}
